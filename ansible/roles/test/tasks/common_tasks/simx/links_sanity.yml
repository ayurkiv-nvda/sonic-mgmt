- fail: msg="minigraph_ports is not defined"
  when: "minigraph_ports is not defined"

- fail: msg="minigraph_portchannels is not defined"
  when: "minigraph_portchannels is not defined"

- name: "Set link timeout facts"
  set_fact:
    retries_value: "20"
    delay_value: "10"

- name: "Set redis db facts"
  set_fact:
    appl_db: "0"
    port_table: "PORT_TABLE"
    lag_table: "LAG_TABLE"

- name: "Verify Port interfaces are up correctly"
  command: bash -c "redis-cli --raw -n {{ appl_db }} HGET '{{ port_table }}:{{ item }}' oper_status | grep 'up'"
  register: out
  until: out.rc == 0
  with_items: "{{ minigraph_ports.keys() }}"
  become: "yes"
  retries: "{{ retries_value }}"
  delay: "{{ delay_value }}"
  when: minigraph_ports|length > 0

- name: "Verify PortChannel interfaces are up correctly"
  command: bash -c "redis-cli --raw -n {{ appl_db }} HGET '{{ lag_table }}:{{ item }}' oper_status | grep 'up'"
  register: out
  until: out.rc == 0
  with_items: "{{ minigraph_portchannels.keys() }}"
  become: "yes"
  retries: "{{ retries_value }}"
  delay: "{{ delay_value }}"
  when: minigraph_portchannels|length > 0
