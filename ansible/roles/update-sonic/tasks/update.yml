# SONiC to SONiC image update on the running device.
# Command example: 
# ansible-playbook -i inventory --limit SWITCH update.yml --tags update -b -vvvvv -e CMD image_url=URL 

- fail: msg="image_url variable should be provided."
  when: image_url is not defined

- set_fact: timestamp="{{lookup('pipe','date +%Y%m%d%H%M%S')}}"

- set_fact: filename="/tmp/update_image_{{ timestamp }}"
- debug: var=filename

- name: Download SONiC image.
  local_action: get_url url={{ image_url }} dest={{ filename }}

- name: Upload SONiC image to device.
  copy:
    src: "{{ filename }}"
    dest: "{{ filename }}"

- name: Remove SONiC image from local server.
  local_action: file path={{ filename }} state=absent

- name: Update SONiC image.
  command: sh {{ filename }}
  register: update_output
  ignore_errors: yes

- fail: msg="{{ update_output.stdout }}"
  when:
    - update_output.rc != 0
    - "'Running SONiC has the same version' not in update_output.stdout"

- name: Reboot device.
  command: /sbin/shutdown -r
  async: 0
  poll: 0
  ignore_errors: true

- name: Wait for device to come back.
  local_action: wait_for host={{ ansible_ssh_host }} state=started

- block:
    - name: Deploy minigraph file.
      copy:
        src: "minigraph/{{ dut_minigraph }}"
        dest: "/etc/sonic/minigraph.xml"

    - name: Change default GW address.
      command: "sed -i \"s/gwaddr = ipaddress.IPAddress(int(mgmtipn.network) + 1)/gwaddr = ipaddress.IPAddress(int(mgmtipn.network) + 254)/\" /usr/local/lib/python2.7/dist-packages/minigraph.py"
      when: "ansible_ssh_host == 'arc-switch1041'"

    - name: Reboot device.
      command: /sbin/shutdown -r
      async: 0
      poll: 0
      ignore_errors: true

    - name: Wait for device to come back.
      local_action: wait_for host={{ ansible_ssh_host }} state=started

    - name: Wait for ASIC interface become up.
      wait_for:
          path: /sys/class/net/Ethernet4/operstate
          search_regex: up

  when: dut_minigraph is defined
