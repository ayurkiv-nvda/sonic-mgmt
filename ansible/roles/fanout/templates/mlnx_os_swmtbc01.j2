{% set eth_ports = ['ERR', '1/9/1', '1/9/2', '1/9/3', '1/9/4', '1/11/1', '1/11/2', '1/11/3', '1/11/4', '1/13/1', '1/13/2', '1/13/3', '1/13/4', '1/15/1', '1/15/2', '1/15/3', '1/15/4', '1/17/1', '1/17/2', '1/17/3', '1/17/4', '1/19/1', '1/19/2', '1/19/3', '1/19/4', '1/21/1', '1/21/2', '1/21/3', '1/21/4', '1/23/1', '1/23/2', '1/23/3', '1/23/4', '1/32'] %}
{% set uplink_port_id = 33 %}
{% set of_ports = [-1, 109, 110, 111, 112, 105, 106, 107, 108, 101, 102, 103, 104, 97, 98, 99, 100, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 95] -%}

config t

no lldp 
no spanning-tree 
ip routing
license install LK2-RESTRICTED_CMDS_GEN2-43A1-4H83-REA1-288A-4QWL-0PW5-U7
interface mgmt0 dhcp
hostname arc-switchmtbc01

no fae trap-group TRAP_GROUP_LLDP policer bind
no fae trap-group TRAP_GROUP_OF_CONTROLLER policer bind

{% for i in range(9,24,2) %}
{% set ifindex = '1/' + i|string %}
interface ethernet {{ ifindex }} module-type qsfp-split-4 force
{% endfor %}

interface ethernet 1/32 switchport mode trunk

vlan 101-132
ex

interface ethernet 1/32 switchport trunk allowed-vlan none

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
interface ethernet {{eth_ports[i]}} switchport access vlan {{ vlanid }}
{% endfor %}

interface ethernet 1/32 switchport trunk allowed-vlan add 101-132
interface ethernet 1/32 switchport trunk allowed-vlan remove 1

protocol openflow

{% for i in range(1, eth_ports|length) %}
interface ethernet {{ eth_ports[i] }} openflow mode hybrid
{% endfor %}

{% set of_counter = 0 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=100,dl_type=0x88CC,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x88CC,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=100,dl_type=0x8809,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x8809,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i  }} table=0,priority=100,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},dl_type=0x0806,actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x0806,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}
