{% set eth_ports = ['ERR', '1/1/1', '1/1/2', '1/1/3', '1/1/4', '1/3/1', '1/3/2', '1/3/3', '1/3/4', '1/5/1', '1/5/2', '1/5/3', '1/5/4', '1/7/1', '1/7/2', '1/7/3', '1/7/4', '1/9/1', '1/9/2', '1/9/3', '1/9/4', '1/11/1', '1/11/2', '1/11/3', '1/11/4', '1/13/1', '1/13/2', '1/13/3', '1/13/4', '1/15/1', '1/15/2', '1/15/3', '1/15/4', '1/32'] %}
{% set uplink_port_id = 33 %}
{% set of_ports = [-1, 125, 126, 127, 128, 121, 122, 123, 124, 117, 118, 119, 120, 113, 114, 115, 116, 109, 110, 111, 112, 105, 106, 107, 108, 101, 102, 103, 104, 97, 98, 99, 100, 95] -%}

config t

no lldp
no spanning-tree
ip routing
license install LK2-RESTRICTED_CMDS_GEN2-43A7-43LN-YFMB-A88A-0VXP-TUXP-RJ
interface mgmt0 dhcp
hostname arc-switchmtbc02
username {{ fanout_root_user }} password {{ fanout_root_pass }}

no fae trap-group TRAP_GROUP_LLDP policer bind
no fae trap-group TRAP_GROUP_OF_CONTROLLER policer bind

{% for i in range(1,16,2) %}
{% set ifindex = '1/' + i|string %}
interface ethernet {{ ifindex }} module-type qsfp-split-4 force
{% endfor %}

{% for i in range(1, eth_ports|length) %}
interface ethernet {{ eth_ports[i] }} shutdown
interface ethernet {{ eth_ports[i] }} mtu 9216
interface ethernet {{ eth_ports[i] }} no shutdown
{% endfor %}
interface ethernet 1/32 switchport mode trunk

interface ethernet 1/1/1-1/1/4 shutdown
interface ethernet 1/1/1-1/1/4 speed 10G
interface ethernet 1/1/1-1/1/4 no shutdown

interface ethernet 1/7/1-1/7/4 shutdown
interface ethernet 1/7/1-1/7/4 speed 10G
interface ethernet 1/7/1-1/7/4 no shutdown

vlan 101-132
ex

interface ethernet 1/32 switchport trunk allowed-vlan none

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
interface ethernet {{eth_ports[i]}} switchport access vlan {{ vlanid }}
{% endfor %}

interface ethernet 1/32 switchport trunk allowed-vlan add 101-132
interface ethernet 1/32 switchport trunk allowed-vlan remove 1

protocol openflow

{% for i in range(1, eth_ports|length) %}
interface ethernet {{ eth_ports[i] }} openflow mode hybrid
{% endfor %}

{% set of_counter = 0 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=100,dl_type=0x88CC,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x88CC,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=100,dl_type=0x8809,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x8809,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i  }} table=0,priority=100,in_port={{ of_ports[uplink_port_id] }},dl_vlan={{ vlanid }},dl_type=0x0806,actions=output:{{ of_ports[i] }}
{% endfor %}

{% set of_counter = of_counter + eth_ports|length-2 -%}

{% for i in range(1,eth_ports|length-1) %}
{% set vlanid = (100+i)|string %}
openflow add-flows {{ of_counter + i }} table=0,priority=101,dl_type=0x0806,in_port={{ of_ports[i] }},actions=mod_vlan_vid:{{ vlanid }},output:{{ of_ports[uplink_port_id] }}
{% endfor %}
